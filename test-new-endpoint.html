<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Nuevo Endpoint Mobile API</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 4px; margin: 10px 0; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .test-button { background: #007cba; color: white; padding: 15px 25px; border: none; border-radius: 4px; cursor: pointer; margin: 10px 5px; font-size: 16px; }
        .test-button:hover { background: #005a87; }
        .test-button:disabled { background: #6c757d; cursor: not-allowed; }
        .section { margin: 30px 0; padding: 20px; border: 2px solid #dee2e6; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>üß™ Test Nuevo Mobile API Endpoint</h1>
    <p><strong>Endpoint:</strong> <code>/wp-content/plugins/GICAACCOUNT/mobile-api.php</code></p>
    <p><strong>Prop√≥sito:</strong> Bypassa el problema HTTP 401 de admin-ajax.php</p>

    <div class="section">
        <h2>üîå 1. Test de Conexi√≥n B√°sica</h2>
        <p>Verificar que el endpoint responde correctamente:</p>
        <button class="test-button" onclick="testConnection()">üöÄ Test Connection</button>
        <div id="connection-result"></div>
    </div>

    <div class="section">
        <h2>üì± 2. Test Registro Token (Simulado)</h2>
        <p>Simular el registro de token como lo hace tu app Android:</p>
        <button class="test-button" onclick="testTokenRegistration()">üì≤ Test Token Registration</button>
        <div id="token-result"></div>
    </div>

    <div class="section">
        <h2>üéØ 3. Test con Token Real de fcm.txt</h2>
        <p>Usar los tokens reales que genera tu app Android:</p>
        <button class="test-button" onclick="testRealToken()">üî• Test Token Real</button>
        <div id="real-token-result"></div>
    </div>

    <div class="section">
        <h2>üìä 4. Test Get Notifications</h2>
        <p>Probar endpoint para obtener notificaciones:</p>
        <button class="test-button" onclick="testGetNotifications()">üîî Test Get Notifications</button>
        <div id="notifications-result"></div>
    </div>

    <div class="section">
        <h2>üìã 5. Informaci√≥n para tu App Android</h2>
        <div class="info">
            <h3>üîß Cambios necesarios en WordPressApiService.java:</h3>
            <pre>// CAMBIAR ESTA L√çNEA:
.url(BASE_URL + "/wp-admin/admin-ajax.php")

// POR ESTA:
.url(BASE_URL + "/wp-content/plugins/GICAACCOUNT/mobile-api.php")</pre>
            
            <h3>üì± Tokens de tu app desde fcm.txt:</h3>
            <ul>
                <li><strong>Token 1:</strong> <code>f0-du7sKSo-LyfDM3Ls-YY:APA91bH...</code></li>
                <li><strong>Token 2:</strong> <code>diDBg-tKSU6VJOpXt-jnxc:APA91bG...</code></li>
                <li><strong>Device ID:</strong> <code>f2953f4f7aca2de8</code></li>
                <li><strong>Device:</strong> Xiaomi 2311DRK48G (Android 15)</li>
            </ul>
        </div>
    </div>

    <script>
        const API_ENDPOINT = '/wp-content/plugins/GICAACCOUNT/mobile-api.php';
        
        function showResult(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            const className = isError ? 'error' : 'success';
            element.innerHTML = `<div class="${className}">${content}</div>`;
        }
        
        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = '<div class="info">üîÑ Ejecutando test...</div>';
        }
        
        async function testConnection() {
            showLoading('connection-result');
            
            try {
                const formData = new FormData();
                formData.append('action', 'test_connection');
                formData.append('api_key', 'gica_mobile_2024');
                formData.append('test_param', 'hello_from_browser');
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: formData
                });
                
                const responseText = await response.text();
                console.log('Connection test response:', responseText);
                
                if (response.ok) {
                    const data = JSON.parse(responseText);
                    if (data.success) {
                        showResult('connection-result', `
                            <h3>‚úÖ Conexi√≥n exitosa!</h3>
                            <p><strong>Mensaje:</strong> ${data.data.message}</p>
                            <p><strong>Servidor:</strong> ${data.data.server_time}</p>
                            <p><strong>WordPress:</strong> ${data.data.wordpress_version}</p>
                            <p><strong>Plugin activo:</strong> ${data.data.plugin_active ? '‚úÖ S√≠' : '‚ùå No'}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `);
                    } else {
                        showResult('connection-result', `‚ùå Error: ${data.error}`, true);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }
                
            } catch (error) {
                console.error('Connection test error:', error);
                showResult('connection-result', `‚ùå Error de conexi√≥n: ${error.message}`, true);
            }
        }
        
        async function testTokenRegistration() {
            showLoading('token-result');
            
            try {
                const formData = new FormData();
                formData.append('action', 'gica_mobile_register_token');
                formData.append('api_key', 'gica_mobile_2024');
                formData.append('fcm_token', 'TEST_TOKEN_' + Date.now());
                formData.append('device_id', 'BROWSER_TEST_' + Date.now());
                formData.append('app_version', '1.0.0');
                formData.append('device_info', 'Browser Test Device');
                formData.append('user_id', '');
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: formData
                });
                
                const responseText = await response.text();
                console.log('Token registration response:', responseText);
                
                if (response.ok) {
                    const data = JSON.parse(responseText);
                    if (data.success) {
                        showResult('token-result', `
                            <h3>‚úÖ Token registrado exitosamente!</h3>
                            <p><strong>Acci√≥n:</strong> ${data.data.action}</p>
                            <p><strong>Device ID:</strong> ${data.data.device_id}</p>
                            <p><strong>Record ID:</strong> ${data.data.record_id}</p>
                            <p><strong>Token Preview:</strong> ${data.data.token_preview}</p>
                            <p><strong>Timestamp:</strong> ${data.data.timestamp}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `);
                    } else {
                        showResult('token-result', `‚ùå Error: ${data.error}`, true);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }
                
            } catch (error) {
                console.error('Token registration error:', error);
                showResult('token-result', `‚ùå Error: ${error.message}`, true);
            }
        }
        
        async function testRealToken() {
            showLoading('real-token-result');
            
            try {
                // Usar el token real de fcm.txt
                const realToken = 'diDBg-tKSU6VJOpXt-jnxc:APA91bGPKtf6lnM7SypPl34Cf-zx55gA5Zj4E6OwE67P-WKD-Yg2GLunKNIh-YU6i8AWg1FGFKRMms-3h3Qy19NPhPzvyJBoa1L0MTqYZkdgkCR451ui_Ho';
                
                const formData = new FormData();
                formData.append('action', 'gica_mobile_register_token');
                formData.append('api_key', 'gica_mobile_2024');
                formData.append('fcm_token', realToken);
                formData.append('device_id', 'f2953f4f7aca2de8');
                formData.append('app_version', '1.0');
                formData.append('device_info', 'Xiaomi 2311DRK48G (Android 15)');
                formData.append('user_id', '');
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: formData
                });
                
                const responseText = await response.text();
                console.log('Real token response:', responseText);
                
                if (response.ok) {
                    const data = JSON.parse(responseText);
                    if (data.success) {
                        showResult('real-token-result', `
                            <h3>üéâ ¬°Token real registrado exitosamente!</h3>
                            <p><strong>Tu dispositivo Android ahora est√° registrado en WordPress!</strong></p>
                            <p><strong>Acci√≥n:</strong> ${data.data.action}</p>
                            <p><strong>Device ID:</strong> ${data.data.device_id}</p>
                            <p><strong>Record ID:</strong> ${data.data.record_id}</p>
                            <p><strong>Timestamp:</strong> ${data.data.timestamp}</p>
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 4px; margin: 15px 0;">
                                <strong>üì± Pr√≥ximo paso:</strong> 
                                <ol>
                                    <li>Ve a WordPress Admin ‚Üí GICA Account ‚Üí FCM</li>
                                    <li>Busca "Dispositivos M√≥viles Registrados"</li>
                                    <li>Deber√≠as ver tu Xiaomi listado</li>
                                    <li>Haz clic en "üß™ Test" para enviar notificaci√≥n</li>
                                </ol>
                            </div>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `);
                    } else {
                        showResult('real-token-result', `‚ùå Error: ${data.error}`, true);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }
                
            } catch (error) {
                console.error('Real token error:', error);
                showResult('real-token-result', `‚ùå Error: ${error.message}`, true);
            }
        }
        
        async function testGetNotifications() {
            showLoading('notifications-result');
            
            try {
                const formData = new FormData();
                formData.append('action', 'gica_mobile_get_notifications');
                formData.append('api_key', 'gica_mobile_2024');
                formData.append('device_id', 'f2953f4f7aca2de8');
                formData.append('limit', '10');
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    body: formData
                });
                
                const responseText = await response.text();
                console.log('Get notifications response:', responseText);
                
                if (response.ok) {
                    const data = JSON.parse(responseText);
                    if (data.success) {
                        showResult('notifications-result', `
                            <h3>‚úÖ Notificaciones obtenidas!</h3>
                            <p><strong>Total:</strong> ${data.data.total_count} notificaciones</p>
                            <p><strong>Timestamp:</strong> ${data.data.timestamp}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `);
                    } else {
                        showResult('notifications-result', `‚ùå Error: ${data.error}`, true);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }
                
            } catch (error) {
                console.error('Get notifications error:', error);
                showResult('notifications-result', `‚ùå Error: ${error.message}`, true);
            }
        }
        
        // Auto-test connection on page load
        window.addEventListener('load', () => {
            setTimeout(testConnection, 500);
        });
    </script>
</body>
</html>